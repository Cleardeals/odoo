<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="property_dashboard.LeadsDashboard" owl="1">
        <div class="o_leads_dashboard" style="overflow-y: auto; height: 100vh;">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-8">
                    <h3>Leads Dashboard</h3>
                </div>
                <div class="col-4 text-right text-muted">
                    <button t-on-click="refreshData" class="btn btn-sm btn-outline-primary me-2" t-att-disabled="state.isLoading">
                        <i class="fa fa-refresh" t-att-class="{'fa-spin': state.isLoading}" role="img" aria-label="Refresh"/>
                        Refresh
                    </button>
                    <i class="fa fa-refresh fa-spin fa-fw" t-if="state.isLoading" role="img" aria-label="Loading..."/>
                    <span t-else="">
                        <i class="fa fa-check-circle fa-fw text-success" role="img" aria-label="Updated"/>
                        <t t-esc="state.lastUpdateTime || 'Just now'"/>
                    </span>
                </div>
            </div>

            <!-- Error Display -->
            <div t-if="state.error" class="alert alert-danger" role="alert">
                <strong>Error:</strong> <t t-esc="state.error"/>
            </div>

            <div t-else="">
                <!-- Tab Navigation -->
                <div class="mb-4">
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-secondary" t-att-class="{'active': state.selectedTab === 'overview'}" t-on-click="switchTab" t-att-value="'overview'">Overview</button>
                        <button class="btn btn-outline-secondary" t-att-class="{'active': state.selectedTab === 'leads'}" t-on-click="switchTab" t-att-value="'leads'">Leads</button>
                        <button class="btn btn-outline-secondary" t-att-class="{'active': state.selectedTab === 'properties'}" t-on-click="switchTab" t-att-value="'properties'">Properties</button>
                        <button class="btn btn-outline-secondary" t-att-class="{'active': state.selectedTab === 'team'}" t-on-click="switchTab" t-att-value="'team'">Team</button>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card shadow-sm text-center p-3 h-100">
                            <h6 class="card-title text-muted mb-1">Total Leads</h6>
                            <h2 class="display-5 font-weight-bold text-dark mb-0">
                                <t t-esc="formatNumber(state.kpis.total_leads || 0)"/>
                            </h2>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card shadow-sm text-center p-3 h-100">
                            <h6 class="card-title text-muted mb-1">Actionable Leads</h6>
                            <h2 class="display-5 font-weight-bold text-primary mb-0">
                                <t t-esc="formatNumber(state.kpis.actionable_leads || 0)"/>
                            </h2>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card shadow-sm text-center p-3 h-100">
                            <h6 class="card-title text-muted mb-1">Site Visit Scheduled</h6>
                            <h2 class="display-5 font-weight-bold text-success mb-0">
                                <t t-esc="formatNumber(state.kpis.site_visit_scheduled || 0)"/>
                            </h2>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card shadow-sm text-center p-3 h-100">
                            <h6 class="card-title text-muted mb-1">Conversion Rate</h6>
                            <h2 class="display-5 font-weight-bold text-info mb-0">
                                <t t-esc="(state.kpis.overall_conversion || 0).toFixed(1)"/>%
                            </h2>
                        </div>
                    </div>
                </div>

                <!-- Overview Section -->
                <div t-if="state.selectedTab === 'overview'" class="row">
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">Conversion Funnel</h6>
                            </div>
                            <div class="card-body p-2" style="height: 300px;">
                                <canvas t-ref="funnelChart"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">Lead Score Distribution</h6>
                            </div>
                            <div class="card-body p-2" style="height: 300px;">
                                <canvas t-ref="scoreChart"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-6 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">WhatsApp Response Types</h6>
                            </div>
                            <div class="card-body p-2" style="height: 300px;">
                                <canvas t-ref="whatsappResponseChart"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leads Section -->
                <div t-if="state.selectedTab === 'leads'" class="row">
                    <div class="col-lg-6 col-md-12 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">Lead Score Distribution</h6>
                            </div>
                            <div class="card-body p-2" style="height: 300px;">
                                <canvas t-ref="scoreChart"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12 mb-3">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">WhatsApp Response Types</h6>
                            </div>
                            <div class="card-body p-2" style="height: 300px;">
                                <canvas t-ref="whatsappResponseChart"/>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">Lead Stage Distribution</h6>
                            </div>
                            <div class="card-body p-2" style="overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="thead-light">
                                        <tr class="bg-light">
                                            <th class="pl-3">Stage</th>
                                            <th>Count</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.kpis.stage_distribution.labels || []" t-as="label" t-key="label">
                                            <tr>
                                                <td class="pl-3"><t t-esc="label"/></td>
                                                <td><t t-esc="state.kpis.stage_distribution.values[label_index]"/></td>
                                                <td><t t-esc="((state.kpis.stage_distribution.values[label_index] / (state.kpis.total_leads || 1)) * 100).toFixed(1)"/>%</td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Properties Section -->
                <div t-if="state.selectedTab === 'properties'" class="row">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">Property Performance</h6>
                            </div>
                            <div class="card-body p-2" style="overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="thead-light">
                                        <tr class="bg-light">
                                            <th class="pl-3">Property Name</th>
                                            <th>Leads</th>
                                            <th>Average Score</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.kpis.property_list || []" t-as="prop" t-key="prop.name">
                                            <tr>
                                                <td class="pl-3"><t t-esc="prop.name"/></td>
                                                <td><t t-esc="prop.leads"/></td>
                                                <td><t t-esc="(prop.avg_score || 0).toFixed(2)"/></td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Section -->
                <div t-if="state.selectedTab === 'team'" class="row">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small">Relationship Managers Performance</h6>
                            </div>
                            <div class="card-body p-2" style="overflow-y: auto;">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="thead-light">
                                        <tr class="bg-light">
                                            <th class="pl-3">RM Name</th>
                                            <th>Total Leads</th>
                                            <th>Average Score</th>
                                            <th>Conversion Rate</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="state.kpis.rm_list || []" t-as="rm" t-key="rm.name">
                                            <tr>
                                                <td class="pl-3"><t t-esc="rm.name"/></td>
                                                <td><t t-esc="rm.total_leads"/></td>
                                                <td><t t-esc="(rm.avg_score || 0).toFixed(2)"/></td>
                                                <td><t t-esc="((rm.conversion_rate || 0) * 100).toFixed(1)"/>%</td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </t>
</templates>